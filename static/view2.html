<!DOCTYPE html>
<html>
  <head>
    <meta name="generator" content="HTML Tidy for Windows (vers 14 February 2006), see www.w3.org">
    <script src="libs/jquery-2.1.1.js" type="text/javascript"></script>
    <script src="libs/d3.v3.js" charset="utf-8" type="text/javascript"></script>
    <script src="libs/chance.js" charset="utf-8" type="text/javascript"></script>
    <script src="js/pills.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery.js" type="text/javascript"></script>
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <meta charset="utf-8">
    <title>
      Pills v0.2 - Visualization of Drug Prescription Patterns
    </title>
    <!--The following script tag downloads a font from the Adobe Edge Web Fonts server for use within the web page. We recommend that you do not modify it.-->

    <script type="text/javascript">
var __adobewebfontsappname__="dreamweaver"
    </script>
    <script src="http://use.edgefonts.net/days-one:n4:default;holtwood-one-sc:n4:default.js" type="text/javascript"></script>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen" type="text/css">
	<link href="css/pills.css" rel="stylesheet" type="text/css">
  </head>

  <body>
  <nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#"></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Visualization of Drug Prescription Patterns <span class="sr-only">(current)</span></a></li>
        <li><a href="#">Help</a></li>   
		<li><a href="#">Contact us</a></li> 		
      </ul>
    </div><!-- /.navbar-collapse -->
  </div>
</nav>

  <div class="container-fluid">
	<div class="row">
		<div class="col-md-3" id="leftcontrol">
			<div class="panel panel-default">
				<div class="panel-heading"> Data Filtering</div>
				<div class="panel-body">
					<form method="post">
						<fieldset>
								<legend><b>Measures</b></legend>
								<input type="checkbox" name="a" value="aa" />MPR(Medication Possession Rate) <br />
								<input type="checkbox" name="b" value="bb" />CSA(Continuous single-interval medication availability)<br />
								<input type="checkbox" name="c" value="cc" />CMG (continuous multiple-interval medication gaps)<br />
						</fieldset>
					</form>
					<form method="post">
						<fieldset>
							<legend><b>Drugs</b></legend>
							<input type="checkbox" name="a" value="aa" />ABC <br />
							<input type="checkbox" name="b" value="bb" />DEF<br />
							<input type="checkbox" name="c" value="cc" />OPP <br />   
						</fieldset>
					</form>
					<form method="post">
						<fieldset>
							<legend><b>Gender</b></legend>
							<input type="checkbox" name="a" value="aa" />Male <br />
							<input type="checkbox" name="b" value="bb" />Female<br />      
						</fieldset>
					</form>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading"> Data Smoothing</div>
				<div class="panel-body"> 
					<form method="post">
						<fieldset>
							<legend><b>Smooth Gaps</b></legend>
							<p>Any gap whose length is smaller than the threshold is removed so that episodes before and after the gaps form a new episode</p>
							
							<!-- <label for="checkbox">
							<input type="checkbox"  name="a" value="aa" />
							Enable Filter
							</label> -->
							<p class="note">Threshold(days) 
							<input id="DF_gaps" type="range" min="0" max="180" step='10' />
							<span id="DF_gaps_currentValue">0</span></p>
						</fieldset>
					</form>
					<form method="post">
						<fieldset>
							<legend><b>Smooth Overlaps </b></legend>
							<p>Any overlap whose length is greater than the threshold is moved/added to the folling episode</p>
							<!-- <br>
							<input type="checkbox" name="a" value="aa" />
							Enable Filter</p> -->
							<p class="note">Threshold(days) 
							<input id="DF_overlaps" type="range" min="0" max="180" step='10' />
							<span id="DF_overlaps_currentValue">0</span></p>          
						</fieldset>
					</form>
				</div>    
			</div>
			<div class="panel panel-default">
				<div class="panel-heading"> Data Setting</div>
				<div class="panel-body"> 
					<form method="post">
						<fieldset>
							<legend><b>Data Source</b></legend>
							<input type="checkbox" name="a" value="aa" />Dataset name 1 (loaded)<br />
							<input type="checkbox" name="b" value="bb" />Dataset name 2 (loaded)<br />
							<input type="checkbox" name="c" value="cc" />Import a new dataset<br />
						</fieldset>
					</form>
					<form method="post">
						<fieldset>
							<legend><b>Preprocessing</b></legend>
							<input type="checkbox" name="a" value="aa" />Using raw data<br />
							<input type="checkbox" name="b" value="bb" />Preprocessing preset A<br />
							<input type="checkbox" name="c" value="cc" />Preprocessign preset B <br />
							<input type="checkbox" name="c" value="cc" />Create a new preprocessing prest<br />                   
						</fieldset>
					</form>
				</div>
			</div>
		</div>
	
		<div class="col-md-6 " id="middleview">
			<div class="panel panel-default">
				<div class="panel-heading" id="middleHeading">MPR</div>
			</div>
		</div>
		<div class="col-md-3 " id="rightcontrol">
			<div class="panel panel-default">
				<div class="panel-heading" > Data Group</div>
				<div class="managingCSS" id="groups">
			</div>
			</div>
		</div>
	</div>

  <script>
  function createChartDiv(id_) {
	 ("div1");
	  var root =  document.getElementById('middleview');
	  var div = document.createElement('div');
	  div.id = id_;
	  div.className="GraphViewCSS";
	  root.appendChild(div);
	  
	  //<div class="GraphViewCSS" id="GraphView"  ></div>
//   <div class="GraphViewCSS" id="GraphView_Time"  ></div>
//   <div class="GraphViewCSS" id="GraphView_Period"  ></div>
  }
  </script>	
  <script>
  var g_rawdata;
  var g_data;

$.getJSON('/data', function(data) {     
			g_rawdata=data;
			initialize();
  });
  
function createPatientGroup(name_,color_)
{
	var g = {name : name_, color : color_, stats : {mprRange : [] , csaRange : [] , cmgRange : [], mpr30 : []}, patientData : [] };
	return g;
}
function constructInitData(data) {



   var Nrange=20;  //MPR range count
	
  for (i=0;i<Nrange;i++){
    data.stats.mprRange[i]={range : 0 , count : 0};
     data.stats.csaRange[i]={range : 0 , count : 0};
     data.stats.cmgRange[i]={range : 0 , count : 0};
  }
  for (i = 0; i < g_rawdata.patients.length; i++) { 
  
  		//only take dominant drug
		var p = g_rawdata.patients[i];
		var periodMax=0;
		var drugIndex=-1;
		if(p.drug_details.length==0) continue;
		for(j=0;j<p.drug_details.length;j++){
			if(p.drug_details[j].total_period>periodMax) {
				periodMax=p.drug_details[j].total_period;
				drugIndex=j;
			}
		}
		if(drugIndex==-1) continue;
		
		//patient data
		data.patientData[i] = new Object();
   		data.patientData[i].id = p.patient_id;		
		data.patientData[i].avgMPR = p.drug_details[drugIndex].mpr.toFixed(4);
		data.patientData[i].totalPeriod = p.drug_details[drugIndex].total_period;
  		
  		//statistical data
		ival = (data.patientData[i].avgMPR*Nrange) | 0; // range index
		if(ival>=Nrange) ival = Nrange-1;
		data.stats.mprRange[ival].range = ival/Nrange
		data.stats.mprRange[ival].count++;
		
		
		//csa
		ival = (p.drug_details[drugIndex].average_csa * Nrange) | 0;
		if(ival>=Nrange) ival = Nrange-1;
		data.stats.csaRange[ival].range = ival/Nrange
		data.stats.csaRange[ival].count++;
		
		//cmg
		ival = (p.drug_details[drugIndex].avg_cmg * Nrange) | 0;
		if(ival>=Nrange) ival = Nrange-1;
		data.stats.cmgRange[ival].range = ival/Nrange
		data.stats.cmgRange[ival].count++;
		
		//mpr30
		
		for(mpr30index =0; mpr30index < p.drug_details[drugIndex].mpr_30.length-1;mpr30index++)
		{
			if(data.stats.mpr30[mpr30index] == undefined) {
				data.stats.mpr30[mpr30index] = {count : 0 , value : 0 , avg:0 };
			} 
			data.stats.mpr30[mpr30index].count++;
			data.stats.mpr30[mpr30index].value +=  p.drug_details[drugIndex].mpr_30[mpr30index];
			
		}		
  
  }	
	for(j =0; j<data.stats.mpr30.length;j++)
	{
		data.stats.mpr30[j].avg = data.stats.mpr30[j].value / data.stats.mpr30[j].count;
	}
  return data;
}
function initialize() {
	g_data = createPatientGroup("default",'#E6E6FA');
	g_data = constructInitData(g_data);

  //construct g_data;
	var w = $('#middleview').width();  
 // var g_ranData = GetRandomMPRData();

//  var d_rangenfrequency = ParseData_MPRRange(g_ranData.MPRALL);
 // var d_mprovertime = GetData_MPR_over_TIME(null);
 
 var o_chartoption = createChartOption(w,400,"MPR","# of Patients",'MPR_DIST');
 createChartDiv('Chart_Bar_MPR_DISTRIBUTION');
 createbarChart(g_data,"Chart_Bar_MPR_DISTRIBUTION", 'new',o_chartoption); 
 
 
 
 o_chartoption = createChartOption(w,400,"Time (Months from the start of medication) ","MPR",'MPR_over_MONTH');
 createChartDiv('Chart_Line_MPR_overMONTH');  
 createLinechart(g_data,"Chart_Line_MPR_overMONTH",'new',o_chartoption);
 
 var o_chartoption = createChartOption(w,400,"Total Medication Period(Days)","MPR","MPR_over_TotalPeriod");
 createChartDiv('Chart_Scatter_MPR_overMONTH'); 
 createScatterchart(g_data,"Chart_Scatter_MPR_overMONTH", 'new',o_chartoption);
 
 
 o_chartoption = createChartOption(w,400,"CSA","# of Patients",'CSA_DIST');
 createChartDiv('Chart_Bar_CSA_DISTRIBUTION');
 createbarChart(g_data,"Chart_Bar_CSA_DISTRIBUTION", 'new',o_chartoption);
 
 o_chartoption = createChartOption(w,400,"CMG","# of Patients",'CMG_DIST');
 createChartDiv('Chart_Bar_CMG_DISTRIBUTION');
 createbarChart(g_data,"Chart_Bar_CMG_DISTRIBUTION", 'new',o_chartoption);
 
 //createLinechart(d_mprovertime,"GraphView_Period",'new','all',o_chartoption);
console.log("initialized\n");
console.log(g_data);
// 
  }
  
$(function(){

    var currentValue = $('#DF_gaps_currentValue');

    $('#DF_gaps').change(function(){
        currentValue.html(this.value);
		//call data reset
			$( ".GraphViewCSS" ).remove();		
		 $.getJSON('/data', {           
              gap: this.value
            },
            function(data) {
            g_rawdata = data;
			renewData();			
        });
    });
    //$('#DF_gaps').change();

});
$(function(){

    var currentValue = $('#DF_overlaps_currentValue');

    $('#DF_overlaps').change(function(){
        currentValue.html(this.value);
		//call data reset
			$( ".GraphViewCSS" ).remove();		
		 $.getJSON('/data', {           
              overlap: this.value
            },
            function(data) {
            g_rawdata = data;
			renewData();			
        });
    });
    //$('#DF_gaps').change();

});
function renewData() {
	console.log('attemping renew data\n');

    console.log(	$( ".GraphViewCSS" ));

	initialize()
	//.remove(this);
	
	
}
 function AddGrouptoUI(groupname,color,filter) {
	 var grouproot = document.getElementById('groups');
	 var div_ = document.createElement("div");
	 var div_child = document.createElement("div");
	 var div_child2 = document.createElement("div");
	 div_.className = 'GroupItemCSS';
	 div_child.className = 'GroupNameCSS';
	 div_child.innerHTML = groupname;
	 div_child.style.background=color;
	 div_.appendChild(div_child);
	 	 div_.appendChild(div_child2);
	 div_child2.innerHTML = filter.MPRFilter.minValue + " <= "+filter.filterMeasure + " <= " +filter.MPRFilter.maxValue;
	 grouproot.appendChild(div_);
 }
function reloadViwew(){
	$( ".GraphViewCSS" ).remove();		
	renewData();
}
window.onresize = reloadViwew;
  </script>
</div>
</body>
</html>
